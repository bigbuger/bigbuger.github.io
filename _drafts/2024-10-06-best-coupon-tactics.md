---
title:  优惠券最优使用策略问题建模及求解器求解
layout: post
tags:   数学 算法 运筹学 线性规划 整数规划
---
我们在网上购物，肯定会想着如何用更便宜的价格进行购买。这绕不开使用优惠券。  
不过现在的平台把优惠券的使用方法和门槛搞得越来越花里胡哨。什么双11、618 等等“购物节”，买个东西想要算清价格怎么来的，难度堪比一些中学数学题🤦。  
本文就针对其中几种简单的情况进行建模，:p。

走，先从最简单的情况入手：手中只有一个打折优惠券，但是该券有使用金额上限。

*** 
## 单个有金额上限打折券
此问题描述起来其实很简单  
就是说有一个优惠券，其优惠减免百分比为 $w$，最大应用金额不能超过 $c$ 。  
(哈，俺为了后面更方便，没使用国内更常见的概念 -- “打几折”，而用 “off”，即9折为 $w = 10$)  
还有 $N$ 个商品，每个商品价格为 $p_{i}$。目标就是让我们得到最大的优惠金额。  

稍微思考一下，我们可知道这里的 $w$ 对我们的使用并没有什么用。  
因为只有个优惠券嘛 :)，只要想办法把能塞进用优惠券的商品加起来最贵就行了，越贵打折的金额就越多嘛。
当然，不是说我们能全部塞进去，要满足不能超过优惠券的“容量” $c$。

嗯，没错，我特意用“容量这个词” 😊，显然这就是一个 [0-1背包问题换皮](https://oi-wiki.org/dp/knapsack/):
> 有 N 个物品和一个容量为 C 的背包，每个物品有重量 $w_{i}$ 和价值 $v_{i}$ 两种属性，
> 要求选若干物品放入背包使背包中物品的总价值最大且背包中物品的总重量不超过背包的容量。
将其中的 $w_{i}$ 和 $v_{i}$ 都换成我们的商品价格 $p_{i}$ ，就是我们 “0-1 优惠券” 问题了 :P 。  

0-1 背包问题网上的解析浩如烟海，俺就省点笔墨。稍微略过。  
嗯，抄录一下数学模型 （$x_i$ 为商品 $i$ 是否“塞进来”, 值当然就是 0-1 嘛）:

$$
 \max \sum\limits_{i=1}^{N} p_{i}x_{i}
$$

$$
s.t. \begin{cases} \sum\limits_{i=1}^{N} p_{i}x_{ij} \le c \\
x_{i} \in [0, 1] \quad \forall i \in [1, N]
\end {cases}
$$

***
## 多个券且每商品只能用一个券
热身完成了，我们循序渐进，对问题进行拓展：假如我们有多个券的情况下该如何分配？先考虑一下每个商品只能一个券的情况吧，现实中某些平台确实是这样限制。如一单只能用一个券，这种情况我们现实中要做对操作便是“拆单”。


### 贪心算法及其局限
我们可以使用简单的贪心算法来求解这个问题：
1. 对优惠券优惠比例进行排序
2. 从比例最高的优惠券开始，使用0-1背包的求算法将其应用商品最大化

这个算法简单，但是有可能得不到最优解。  
例如当商品价格如下

| 商品 | 价格 |
|:----:|:----:|
| p1   | 4    |
| p2   | 3    |
| p3   | 2    |


优惠比例和最大可用金额如下

| 优惠券 | 最大可用金额 | 折扣比例 |
|:------:|:------------:|:---------:|
| c1     | 5            | 0.2      |
| c2     | 3            | 0.15     |

应用该算法得到如下结果

| 优惠券 | 应用商品 | 折扣比例 | 商品金额 | 优惠金额 |
|:------:|:--------:|:--------:|:--------:|:--------:|
| c1     | p2 p3    | 0.2      | 5        | 1.       |
| c2     |          | 0.15     | 0        | 0.       |
|:------:|:--------:|:--------:|:--------:|:--------:|
| 合计   |          |          |          | 1.       |

但是真正的最优使用方法如下

| 优惠券 | 应用商品 | 折扣比例 | 商品金额 | 优惠金额 |
|:------:|:--------:|:--------:|:--------:|:--------:|
| c1     | p1       | 0.2      | 4        | 0.8      |
| c2     | p2       | 0.15     | 3        | 0.45     |
|:------:|:--------:|:--------:|:--------:|:--------:|
| 合计   |          |          |          | 1.25     |

可见该贪心算法不一定得到最优解。

很容易想到另一种改进的贪心算法，是考虑的不是简单的用最大可用金额进行优惠券的排序，而是用 折扣比例/最大可用金额 来排序，可用叫其为单位优惠金额:)。  
但是这样同样在某些情况也得不到最优解:

| 优惠券 | 最大可用金额 | 折扣比例 | 单位优惠金额 |
|:------:|:------------:|:--------:|:------------:|
| c1     | 5            | 0.3      | 0.06         |
| c2     | 3            | 0.15     | 0.05         |

应用该算法得到如下结果

| 优惠券 | 应用商品 | 折扣比例 | 商品金额 | 优惠金额 |
|:------:|:--------:|:--------:|:--------:|:--------:|
| c1     | p2 p3    | 0.3      | 5        | 1.5      |
| c2     |          | 0.15     | 0        | 0.       |
|:------:|:--------:|:--------:|:--------:|:--------:|
| 合计   |          |          |          | 1.5      |

而实际上的最优方案其实是这样的: 

| 优惠券 | 应用商品 | 折扣比例 | 商品金额 | 优惠金额 |
|:------:|:--------:|:--------:|:--------:|:--------:|
| c1     | p1       | 0.3      | 4        | 1.2      |
| c2     | p2       | 0.15     | 3        | 0.45     |
|:------:|:--------:|:--------:|:--------:|:--------:|
| 合计   |          |          |          | 1.65     |


### 问题
既然贪心算法不一定凑效，那么我们现在就对问题进行分析建模，然后交给求解器去解决。  
开始分析，先列出我们有哪些变量、条件及目标：
- 商品 $N$ 个，每个商品 $i$ 价格为 $p_{i}$
- 优惠券 $M$ 个， 每个优惠券 $j$ 减免百分比为 $w_{j}$
- 条件1: 每个优惠券 $j$ 应用的商品金额不能超过 $c_{j}$
- 条件2: 每个商品只能用 1 张优惠券
- 求: 怎样应用优惠券能达到最大优惠

### 建模
建立模型的第一步当然要引入我们的变量：记 $x_{ij}$ 为是否为商品 $i$ 使用优惠券 $j$，使用时 $x_{ij} = 1$，否则 $x_{ij} = 0$。  
注意我们这里的 $x$ 是二维的，而单个优惠券的时候是一维的，因为有多个券和多个商品可用产生应用关系。

若商品 $i$ 应用优惠券 $j$，则产生的优惠金额 $p_{i}w_{j}$；且此时$x_{ij}=1$， 故 $x_{ij}$ 乘上该金额，则可表示是有实际获得该优惠。

对于每个优惠券 $j$，其总优惠金额为 $\sum\limits_{i=1}^{N}{p_{i}w_{j}x_{ij}}$ 。  
继而所有优惠券优惠总和为 $\sum\limits_{j=1}^{M} \sum\limits_{i=1}^{N} p_{i}w_jx_{ij}$，我们的目标就是将这个值最大化。

***
目标的表达式写出了，我们反过来看看约束条件。

对于条件 1，我们很容易就知道对于每个优惠券 $j$ 而言，其为表达式为 $\sum\limits_{i=1}^{N} p_{i}x_{ij} \le c_{j}$ 。

条件 2 就需要转转脑筋 :P, 对于每个给定的商品 $i$ 其最直接的表述为 对于所有 $j \in [1, M]$ ，$x_{ij}$ 最多只有一个为1。  
那么我们对所有 $x_{ij}$ 求和，则可以肯定其和最大值不超过1;反过来，若其最大值不超过1，也可以推出 $x_{ij}$ 最多只有一个1。  
因此，条件 2 可以表达为 $\sum\limits_{j=1}^{M} {x_{ij}} \le 1$, 对于 $j \in [1, M]$ 都成立。

***
综上，我们的模型为:

$$
 \max \quad \sum\limits_{j=1}^{M} \sum\limits_{i=1}^{N} p_{i}w_{j} x_{ij}
$$

$$
 s.t. \quad \begin{cases}
	\sum\limits_{i=1}^{N} p_{i}x_{ij} \le c_{j} \quad \forall j \in [1, M] \\

	\sum\limits_{j=1}^{M} {x_{ij}} \le 1 \quad \forall i \in [1, N] \\
x_{ij} \in [0, 1] \quad \forall i \in [1, N], j \in [1, M]
\end{cases}

$$


模型有了，我们看看该模型是否可对应到已知的问题类型。既然单个优惠券是0-1背包问题，那么我们这里多个优惠券是不是也是背包问题呢？
其实这是一个 [广义分配问题](https://en.wikipedia.org/wiki/Generalized_assignment_problem)，背包问题是其的一个特例。

### 求解器解决
有模型了，就可用开始写代码丢给求解器来帮我们解决问题了。  
这里使用 [glpk](https://www.gnu.org/software/glpk/) 进行求解。

先定义我们的数据文件 *one_product_to_one_coupon.dat* :

<pre class="highlight">{% include /code/best-coupon-tactics/1p_to_1c.dat %}</pre>

为了进行求解，我们要有 gmpl 代码 *gmpl_1p_to_1c.mod*，其实就是前面的数学模型原样翻译:

<pre class="highlight">{% include /code/best-coupon-tactics/gmpl_1p_to_1c.mod %}</pre>

运行:
```shell
glpsol -m gmpl_1p_to_1c.mod -d 1p_to_1c.dat | \
awk '/result end/{flag=0;next} flag; /result start/{flag=1;next;}'
```

结果:
>优惠券 c1, 应用到下列商品:  
>p1  
>优惠券 c2, 应用到下列商品:  
>p2  
>最大优惠金额: 1.250000  

***
## 可以叠加
继续往前，我们解决问题的方法都是从简单或者已知问题出发，逐步拓展 :)。
有了多个券，我们自然要处理可以同时应该多个优惠券的情况，即券可以叠加。
Let's go (*^_^*)

### 问题
本问题的要素和前面一样，只不过条件变了
- 条件1: 每个优惠券 $j$ 应用的商品金额不能超过 $c_{j}$ (和前面一样)
- 条件2: 每个商品可用多个优惠券，部分优惠券之间存在互斥关系（即同一个商品不能同时应用互斥的券）

### 建模
来创建目标函数吧。这里要求的变量和前面一摸一样，$x_{ij}$ 为是否为商品 $i$ 使用优惠券 $j$。

我们应用单个优惠券后产生的优惠金额也是一样的：$p_{i}w_{j}x_{ij}$。我们不能直接应用这个到我们的目标函数，还要处理叠加。  
先考虑叠加两个优惠券 $j_1$ 和 $j_2$，显然叠加后的优惠金额为 $p_{i}w_{j_1}w_{j_2}$。这个表达式没有 $x$，需要把它弄进去。  
如果我们直接将 $x$ 乘进去会怎样？  
这恐怕行不通: 这样我们的表达式为 $p_{i} w_{i j_1} x_{i j_1} w_{i j_2} x_{i j_2}$。在两个券都用的时候确实是对的。但若只用1个券，则该式的值一定为0，显然不到。  

看来想用优惠金额来作为我们的目标函数有点困难。不妨考虑将我们的目标改为最小化最后应付金额 :)。  
单个优惠券 $j_1$ 应用到商品 $i$ 后，要付款的金额为 $p_{i}(1-w_{j_{1}}x_{ij_1})$;  
和另一个优惠券 $j_2$ 叠加后，则为 $p_{i}(1-w_{j1}x_{ij_{1}})(1-w_{j_{2}}x_{ij_{2}})$ 。(我们不用“折”的概念，而使用 “off”，是为了这儿表达更方便)  
可得单个商品 $p_{j}$ 最后要付金额为

$$
p_{i}\prod\limits_{j=1}^{M}(1-w_{j}x_{ij})
$$

应付总金额则为 

$$
\sum\limits_{i=1}^{N}p_{i}\prod\limits_{j=1}^{M}(1-w_{j}x_{ij})
$$

我们的目标是要令其值最小化。

***
目标函数有了，来解决我们的条件。条件1没变，和前面一样。
下面对条件2（互斥）进行建模
记 $a_{gk}$ 为优惠券 $g$ 和 $k$ 是否互斥，0 为不互斥，1 为互斥

则互斥优惠券 $g$ 和 $k$ 同时应用到一个商品 $i$ 时有 $x_{ig} + x_{ik}=2$

此时若 $a_{gk}=1$ 则 $(x_{ig} + x_{ik})a_{gk}= 2$；反之，若 $a_{gk}=0$ 则  $(x_{ig} + x_{ik})a_{gk}= 0$

所以我们的互斥条件可以表示为 $(x_{ig} + x_{ik})a_{gk} \le 1$

***
综上，我们的模型为

$$
\min \quad \sum\limits_{i=1}^{N}p_{i}\prod\limits_{j=1}^{M}(1-w_{j}x_{ij})
$$

$$
s.t. \quad \begin{cases}
\sum\limits_{i=1}^{N} p_{i}x_{ij} \le c_{j} \quad \forall j \in [1, M] \\
(x_{ig} + x_{ik})a_{gk} \le 1 \quad \forall g,k \in [1, M], i \in [1, N] \\
x_{ij} \in [0, 1] \quad \forall i \in [1, N], j \in [1, M]
\end{cases}
$$

此模型的目标函数和[武器目标分配(WTA)](https://en.wikipedia.org/wiki/Weapon_target_assignment_problem)问题是一样的（[详见论文](https://sysengi.cjoe.ac.cn/CN/10.12011/1000-6788-2017-1506-07)）。  
惊不惊喜，意不意外？！读者可能诧异于为什么我买个东西还跟打仗扯上关系了？
WTA 问题其实是已知敌人们的“血条”，和我们武器（一次性使用）对敌人的攻击力，求如何分配武器进行攻击才能使得敌人的“血条”尽可能清空。这里我们的商品便是“敌人”，“血条”是其价格，“攻击力”即优惠券的折扣；理念转化后，不难理解两者间的关联了。

如果我们同优惠券有多张，那么 $x_{ij}$ 表示优惠券 $j$ 应用到商品 $i$ 的次数。则目标函数为

$$
 \min \quad \sum\limits_{i=1}^{N}p_{i}\prod\limits_{j=1}^{M}(1-w_{j})^{x_{ij}}
$$

这就完全和武器目标分配问题的目标函数一样了。不过对于同一类优惠券，可以建模为多张同等价值的优惠券，目标函数就变为上面所设计的了。

### 求解器求解

## 满减
TODO
